<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anna's Library</title>

    <!-- Enlaces y metas para PWA -->
    <link rel="manifest" href="manifest.json">
    <!-- Color de la barra de estado en móviles -->
    <meta name="theme-color" content="#a855f7">
    <!-- Icono para iOS -->
    <link rel="apple-touch-icon" href="images/icon-192.png">

    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-principal: #800020;
            --color-secundario: #A04040;
            --color-fondo: #f4f4f4;
            --color-texto: #333;
            --color-caja: #fff;
            --sombra-suave: 0 4px 6px rgba(0,0,0,0.1);
            --color-borde: #ccc;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Lora', serif;
            background-color: var(--color-fondo);
            color: var(--color-texto);
            padding: 20px;
            line-height: 1.6;
        }
        .contenedor-principal {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--color-caja);
            border-radius: 12px;
            box-shadow: var(--sombra-suave);
        }
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            text-align: center;
            color: var(--color-principal);
            margin-bottom: 1.5rem;
        }
        h1 { font-size: 2.5rem; }
        h2 { font-size: 1.5rem; text-align: left; margin-bottom: 1rem; }
        .btn-agregar-libro, .btn-libro-aleatorio, .btn-accion {
            display: block;
            width: fit-content;
            margin: 0 auto 15px;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 8px;
            background-color: var(--color-principal);
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.3s ease;
        }
        .btn-accion {
            margin: 0;
            padding: 8px 16px;
        }
        .btn-agregar-libro:hover, .btn-libro-aleatorio:hover, .btn-accion:hover {
            background-color: var(--color-secundario);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .btn-secundario {
            background-color: var(--color-borde);
            color: var(--color-texto);
        }
        .btn-secundario:hover {
            background-color: #aaa;
        }
        .opciones-filtro {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .opciones-filtro select,
        .opciones-filtro input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--color-borde);
            min-width: 150px;
        }
        .contenedor-acciones {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .estanteria {
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        .saga {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        .saga-titulo {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            position: relative;
        }
        .saga-titulo h3 {
            margin: 0;
            text-align: left;
            flex-grow: 1;
        }
        .libros-contenedor {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .libro-entry {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 120px;
            margin-bottom: 20px;
            position: relative;
        }
        .vista-lista .libro-entry {
            flex-direction: row;
            width: 100%;
            align-items: flex-start;
            border-bottom: 1px solid var(--color-borde);
            padding: 10px;
            gap: 15px;
        }
        .vista-lista .libro {
            width: 60px;
            height: 90px;
            margin-bottom: 0;
        }
        .libro:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        .vista-lista .libro:hover {
            transform: none;
        }
        .libro-img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
            transition: opacity 0.3s ease;
        }
        .estrellas {
            text-align: center;
            font-size: 1.2rem;
            color: gold;
            cursor: pointer;
            user-select: none;
        }
        .estrella {
            transition: transform 0.2s;
            display: inline-block;
        }
        .estrella:hover {
            transform: scale(1.2);
        }
        .btn-saga-accion {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-principal);
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        .btn-saga-accion:hover {
            opacity: 1;
        }
        .libro-titulo {
            font-family: 'Montserrat', sans-serif;
            font-size: 0.85rem;
            font-weight: bold;
            text-align: center;
            margin-top: 5px;
            min-height: 20px;
        }
        .vista-lista .libro-titulo {
            text-align: left;
            margin-top: 0;
            font-size: 1rem;
            flex-grow: 1;
            align-self: center;
        }
        .leido-indicador {
            position: absolute;
            top: 5px;
            left: 5px;
            font-size: 1.5rem;
            color: white;
            background-color: #222;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        /* Estilo para oscurecer libros no leídos */
        .libro-no-leido .libro-img {
            filter: brightness(50%) grayscale(100%);
            transition: filter 0.3s ease;
        }
        .libro-no-leido:hover .libro-img {
            filter: none;
        }

        /* Estilos de Drag and Drop */
        .libro-entry.dragging {
            opacity: 0.5;
            transform: scale(0.9);
            box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            cursor: grabbing;
        }
        .libros-contenedor.drag-over .libro-entry:not(.dragging) {
            transition: transform 0.3s ease;
        }
        .libro-entry.drop-target {
            background-color: #e0e0e0;
            border: 2px dashed var(--color-principal);
            border-radius: 8px;
        }
        
        /* Menú de 3 puntos */
        .saga-menu {
            position: relative;
            z-index: 10;
        }
        .saga-menu-btn {
            background: none;
            color: var(--color-principal);
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.2s;
            padding: 5px;
        }
        .saga-menu-btn:hover { color: var(--color-secundario); }
        .saga-menu-content {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background-color: white;
            min-width: 180px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border-radius: 8px;
            z-index: 1;
        }
        .saga-menu-content a {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
        }
        .saga-menu-content a:hover { background-color: #f1f1f1; }
        .saga-menu-content.show { display: block; }

        .telegram-share-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--color-principal);
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
            padding: 5px;
        }
        .telegram-share-btn:hover {
            color: var(--color-secundario);
        }

        /* Barra de progreso de la saga */
        .progress-bar-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
            height: 20px;
            position: relative;
        }
        .progress-bar {
            background-color: var(--color-principal);
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        .vista-lista .progress-bar-container {
            display: none;
        }
        
        /* Responsive */
        @media (max-width: 600px) {
            body { padding: 10px; }
            .contenedor-principal { padding: 10px; }
            h1 { font-size: 2rem; }
            .libros-contenedor { justify-content: center; }
            .vista-lista .libro-entry { flex-direction: column; align-items: center; }
            .vista-lista .libro-titulo { text-align: center; }
        }

        /* Modal General */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s;
        }
        .modal-contenido {
            background-color: var(--color-caja);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--sombra-suave);
            width: 90%;
            max-width: 450px;
            transform: scale(0.9);
            animation: scaleIn 0.3s forwards;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-contenido p {
            font-size: 1.1rem;
            margin-bottom: 20px;
            text-align: center;
        }
        .modal-warning {
            color: #d9534f;
            font-weight: bold;
            font-family: 'Montserrat', sans-serif;
            margin-bottom: 10px;
        }
        .modal-botones {
            text-align: center;
            margin-top: 20px;
        }
        .modal-botones button {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            font-weight: bold;
            cursor: pointer;
        }
        .modal-botones .btn-ok { background-color: var(--color-principal); color: white; }
        .modal-botones .btn-cancel { background-color: #ccc; color: var(--color-texto); }
        .modal-cerrar {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 2rem;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
        }
        .formulario-modal-campos {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .formulario-modal-campos input,
        .formulario-modal-campos select {
            padding: 12px;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
            transition: all 0.3s ease;
        }
        .formulario-modal-campos input:focus,
        .formulario-modal-campos select:focus {
            outline: none;
            border-color: var(--color-secundario);
            box-shadow: 0 0 0 3px rgba(128, 0, 32, 0.2);
        }
        .libro-seleccionar {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .libro-seleccionar:last-child { border-bottom: none; }
        .libro-seleccionar-titulo {
            flex-grow: 1;
            font-family: 'Montserrat', sans-serif;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes scaleIn { from { transform: scale(0.9); } to { transform: scale(1); } }
    </style>
</head>
<body>

<div class="contenedor-principal">
    <h1>Mi Estantería de Sagas</h1>
    <p class="modal-warning" style="text-align:center; margin-bottom:20px; font-weight:bold;">
        Ten en cuenta: las imágenes grandes pueden superar el límite de almacenamiento de tu navegador. Si ves un error, intenta usar un enlace de imagen en su lugar.
    </p>

    <div class="contenedor-acciones">
        <button class="btn-accion" onclick="mostrarModalAgregar('nueva')">Agregar saga</button>
        <button class="btn-accion btn-secundario" onclick="toggleVista()">Alternar Vista</button>
        <button class="btn-accion btn-secundario" onclick="recomendarSiguienteLibro()">¿Qué leer ahora?</button>
    </div>
    <div class="contenedor-acciones">
        <button class="btn-accion btn-secundario" onclick="exportarSagas()">Exportar datos</button>
        <label class="btn-accion btn-secundario">
            Importar datos
            <input type="file" id="importFile" accept=".json" style="display:none;" onchange="importarSagas()">
        </label>
    </div>

    <div class="opciones-filtro">
        <select id="ordenSelect" onchange="renderSagas()"> 
            <option value="alfabetico">Ordenar A → Z</option>
            <option value="modificado">Última modificada primero</option>
        </select>
        <input type="search" id="search" placeholder="Buscar..." oninput="renderSagas()">
    </div>

    <div id="estanteria" class="estanteria"></div>
</div>

<!-- Modal para agregar libros -->
<div id="addBookModal" class="modal">
    <div class="modal-contenido">
        <span class="modal-cerrar" onclick="cerrarModalAgregar()">&times;</span>
        <h2 style="text-align:center;">Agregar libro(s)</h2>
        <div class="formulario-modal-campos">
            <p style="font-size: 0.9rem; text-align: left; color: #555; margin-bottom: 5px;">
                Para agregar varios libros a la vez, usa `;` para separar cada título o enlace.
                Asegúrate de que la cantidad de títulos coincida con la cantidad de enlaces de imagen.
            </p>
            <input type="text" id="nombreSaga" placeholder="Nombre de la saga" required>
            <input type="text" id="autorSaga" placeholder="Autor" required>
            <input type="text" id="enlaceSaga" placeholder="Enlace a la saga (opcional)">
            <input type="text" id="tituloLibro" placeholder="Título(s) de libro (ej: Libro 1; Libro 2)" required>
            <input type="text" id="imagenLink" placeholder="Enlace(s) de imagen (ej: link1.jpg; link2.png)">
            <input type="file" id="imagenArchivo" accept="image/*" multiple>
            <button class="btn-agregar-libro" onclick="agregarLibro()">Guardar libro(s)</button>
        </div>
    </div>
</div>

<!-- Modal para editar un libro -->
<div id="editBookModal" class="modal">
    <div class="modal-contenido">
        <span class="modal-cerrar" onclick="cerrarModalEditarLibro()">&times;</span>
        <h2 style="text-align:center;">Editar libro</h2>
        <div class="formulario-modal-campos">
            <input type="text" id="editTitulo" placeholder="Título del libro" required>
            <input type="text" id="editImagenLink" placeholder="Enlace de imagen">
            <input type="file" id="editImagenArchivo" accept="image/*">
            <button class="btn-agregar-libro" onclick="guardarEdicionLibro()">Guardar cambios</button>
        </div>
    </div>
</div>

<!-- Modal para editar una saga -->
<div id="editSagaModal" class="modal">
    <div class="modal-contenido">
        <span class="modal-cerrar" onclick="cerrarModalEditarSaga()">&times;</span>
        <h2 style="text-align:center;">Editar saga</h2>
        <div class="formulario-modal-campos">
            <input type="text" id="editSagaNombre" placeholder="Nombre de la saga" required>
            <input type="text" id="editSagaAutor" placeholder="Autor de la saga" required>
            <input type="text" id="editSagaLink" placeholder="Enlace de la saga" required>
            <button class="btn-agregar-libro" onclick="guardarEdicionSaga()">Guardar cambios</button>
        </div>
    </div>
</div>

<!-- Modal para agregar libros a una saga existente -->
<div id="addBookToExistingSagaModal" class="modal">
    <div class="modal-contenido">
        <span class="modal-cerrar" onclick="cerrarModalAgregarLibroExistente()">&times;</span>
        <h2 style="text-align:center;">Agregar libro(s) a la saga</h2>
        <div class="formulario-modal-campos">
            <p style="font-size: 0.9rem; text-align: left; color: #555; margin-bottom: 5px;">
                Para agregar varios libros a la vez, usa `;` para separar cada título o enlace.
                Asegúrate de que la cantidad de títulos coincida con la cantidad de enlaces de imagen.
            </p>
            <input type="text" id="tituloLibroExistente" placeholder="Título(s) de libro (ej: Libro 1; Libro 2)" required>
            <input type="text" id="imagenLinkExistente" placeholder="Enlace(s) de imagen (ej: link1.jpg; link2.png)">
            <input type="file" id="imagenArchivoExistente" accept="image/*" multiple>
            <button class="btn-agregar-libro" onclick="agregarLibroExistente()">Guardar libro(s)</button>
        </div>
    </div>
</div>

<!-- Modal para seleccionar libro -->
<div id="selectBookModal" class="modal">
    <div class="modal-contenido">
        <span class="modal-cerrar" onclick="cerrarModalSeleccionarLibro()">&times;</span>
        <h2 id="selectBookTitle" style="text-align:center;"></h2>
        <div id="selectBookList"></div>
    </div>
</div>

<!-- Custom Modal para mensajes y confirmaciones -->
<div id="customModal" class="modal">
    <div class="modal-contenido">
        <span class="modal-cerrar" onclick="cerrarModalPersonalizado()">&times;</span>
        <p id="modalMessage"></p>
        <div class="modal-botones">
            <button id="modalOkBtn" class="btn-ok">OK</button>
            <button id="modalCancelBtn" class="btn-cancel" style="display:none;">Cancelar</button>
        </div>
    </div>
</div>

<script>
    // Variables globales para el estado de la aplicación.
    let sagas = JSON.parse(localStorage.getItem('misSagas')) || {};
    let draggedBookInfo = null;
    let editSagaKey = null;
    let editBookIndex = null;
    let currentSagaForAction = null;
    let currentView = 'estanteria';

    // --- Funciones de persistencia y utilidad ---
    function guardarSagas() { 
        try {
            localStorage.setItem('misSagas', JSON.stringify(sagas));
        } catch (e) {
            if (e.name === 'QuotaExceededError') {
                showMessage("No se pudo guardar la imagen. Excediste el límite de almacenamiento de tu navegador. Por favor, utiliza un enlace de imagen en su lugar.", false);
            } else {
                console.error("Error al guardar en localStorage:", e);
            }
        }
    }

    // Nueva función para capitalizar la primera letra de cada palabra
    function capitalizeAllWords(str) {
        if (!str) return '';
        return str.toLowerCase().split(' ').map(word => {
            if (word.length === 0) return '';
            return word.charAt(0).toUpperCase() + word.slice(1);
        }).join(' ');
    }

    // --- Funciones de control de modales ---
    function mostrarModalAgregar() {
        document.getElementById('addBookModal').style.display = 'flex';
        limpiarCamposAgregar();
    }

    function cerrarModalAgregar() {
        document.getElementById('addBookModal').style.display = 'none';
        limpiarCamposAgregar();
    }

    function limpiarCamposAgregar() {
        document.getElementById('nombreSaga').value = '';
        document.getElementById('autorSaga').value = '';
        document.getElementById('tituloLibro').value = '';
        document.getElementById('imagenArchivo').value = '';
        document.getElementById('imagenLink').value = '';
        document.getElementById('enlaceSaga').value = '';
    }

    function mostrarModalEditarLibro(sagaKey, index) {
        editSagaKey = sagaKey;
        editBookIndex = index;
        const libro = sagas[sagaKey].libros[index];
        document.getElementById('editTitulo').value = libro.titulo;
        document.getElementById('editImagenLink').value = Array.isArray(libro.img) && libro.img.length > 0 && libro.img[0].startsWith('http') ? libro.img[0] : '';
        document.getElementById('editImagenArchivo').value = '';
        document.getElementById('editBookModal').style.display = 'flex';
        cerrarModalSeleccionarLibro();
    }

    function cerrarModalEditarLibro() {
        document.getElementById('editBookModal').style.display = 'none';
        editSagaKey = null;
        editBookIndex = null;
    }

    function mostrarModalEditarSaga(sagaKey) {
        currentSagaForAction = sagaKey;
        const saga = sagas[sagaKey];
        document.getElementById('editSagaNombre').value = saga.nombre;
        document.getElementById('editSagaAutor').value = saga.autor;
        document.getElementById('editSagaLink').value = saga.link || '';
        document.getElementById('editSagaModal').style.display = 'flex';
    }

    function cerrarModalEditarSaga() {
        document.getElementById('editSagaModal').style.display = 'none';
    }

    function mostrarModalAgregarLibroExistente(sagaKey) {
        currentSagaForAction = sagaKey;
        document.getElementById('addBookToExistingSagaModal').style.display = 'flex';
        document.getElementById('tituloLibroExistente').value = '';
        document.getElementById('imagenLinkExistente').value = '';
        document.getElementById('imagenArchivoExistente').value = '';
        
    }

    function cerrarModalAgregarLibroExistente() {
        document.getElementById('addBookToExistingSagaModal').style.display = 'none';
    }

    function mostrarModalSeleccionarLibro(sagaKey, action) {
        currentSagaForAction = sagaKey;
        const saga = sagas[sagaKey];
        const modalTitle = document.getElementById('selectBookTitle');
        const modalList = document.getElementById('selectBookList');
        modalList.innerHTML = '';
        
        modalTitle.textContent = action === 'editar' ? 'Selecciona un libro para editar' : 'Selecciona un libro para eliminar';

        saga.libros.forEach((libro, index) => {
            const libroDiv = document.createElement('div');
            libroDiv.className = 'libro-seleccionar';
            
            const tituloSpan = document.createElement('span');
            tituloSpan.className = 'libro-seleccionar-titulo';
            tituloSpan.textContent = libro.titulo;

            const botonAccion = document.createElement('button');
            botonAccion.className = 'btn-accion';
            botonAccion.textContent = action === 'editar' ? 'Editar' : 'Eliminar';
            
            botonAccion.onclick = () => {
                if (action === 'editar') {
                    mostrarModalEditarLibro(sagaKey, index);
                } else {
                    eliminarLibro(sagaKey, index);
                }
            };
            
            libroDiv.appendChild(tituloSpan);
            libroDiv.appendChild(botonAccion);
            modalList.appendChild(libroDiv);
        });

        document.getElementById('selectBookModal').style.display = 'flex';
    }

    function cerrarModalSeleccionarLibro() {
        document.getElementById('selectBookModal').style.display = 'none';
        currentSagaForAction = null;
    }

    function cerrarModalPersonalizado() {
        document.getElementById('customModal').style.display = 'none';
    }

    // --- Funciones de gestión de sagas y libros ---
    function agregarLibro() {
        const nombreSaga = document.getElementById('nombreSaga').value.trim();
        const autorSaga = document.getElementById('autorSaga').value.trim();
        const enlaceSaga = document.getElementById('enlaceSaga').value.trim();
        const tituloLibroInput = document.getElementById('tituloLibro').value.trim();
        const imagenLinkInput = document.getElementById('imagenLink').value.trim();
        const imagenArchivos = document.getElementById('imagenArchivo').files;

        if (!nombreSaga || !autorSaga) {
            showMessage("Por favor, rellena los campos de Saga y Autor.", false);
            return;
        }

        const titulos = tituloLibroInput.split(';').map(t => t.trim()).filter(Boolean);
        const enlaces = imagenLinkInput.split(';').map(l => l.trim()).filter(Boolean);
        const archivos = Array.from(imagenArchivos);

        if ((enlaces.length > 0 && archivos.length > 0) || (titulos.length !== enlaces.length && titulos.length !== archivos.length)) {
            showMessage("Por favor, usa solo enlaces o solo archivos, y asegúrate de que el número de títulos coincida con el número de imágenes.", false);
            return;
        }

        if (titulos.length === 0) {
            showMessage("Por favor, introduce al menos un título y un enlace o archivo de imagen.", false);
            return;
        }

        if (archivos.length > 0) {
            if (archivos.some(file => file.size > 1000000)) {
                showMessage("Una o más imágenes que intentas subir son demasiado grandes. Por favor, comprímelas o utiliza enlaces de imagen.", false);
                return;
            }

            const readers = archivos.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            });

            Promise.all(readers).then(results => {
                for (let i = 0; i < titulos.length; i++) {
                    const titulo = titulos[i];
                    addBookToSaga(nombreSaga, autorSaga, titulo, results[i] ? [results[i]] : [], enlaceSaga);
                }
            }).catch(e => {
                console.error("Error leyendo archivos:", e);
                showMessage("Hubo un error al leer los archivos de imagen.", false);
            });
        } else if (enlaces.length > 0) {
            for (let i = 0; i < titulos.length; i++) {
                const titulo = titulos[i];
                const link = enlaces[i];
                addBookToSaga(nombreSaga, autorSaga, titulo, [link], enlaceSaga);
            }
        } else {
            showMessage("Por favor, rellena los campos de título/enlace o selecciona un archivo de imagen.", false);
        }
    }

    function agregarLibroExistente() {
        const tituloLibroInput = document.getElementById('tituloLibroExistente').value.trim();
        const imagenLinkInput = document.getElementById('imagenLinkExistente').value.trim();
        const imagenArchivos = document.getElementById('imagenArchivoExistente').files;
        const saga = sagas[currentSagaForAction];

        if (!tituloLibroInput) {
            showMessage("Por favor, introduce al menos un título.", false);
            return;
        }

        const titulos = tituloLibroInput.split(';').map(t => t.trim()).filter(Boolean);
        const enlaces = imagenLinkInput.split(';').map(l => l.trim()).filter(Boolean);
        const archivos = Array.from(imagenArchivos);
        
        if ((enlaces.length > 0 && archivos.length > 0) || (titulos.length !== enlaces.length && titulos.length !== archivos.length)) {
            showMessage("Por favor, usa solo enlaces o solo archivos, y asegúrate de que el número de títulos coincida con el número de imágenes.", false);
            return;
        }

        if (archivos.length > 0) {
            if (archivos.some(file => file.size > 1000000)) {
                showMessage("Una o más imágenes que intentas subir son demasiado grandes. Por favor, comprímelas o utiliza enlaces de imagen.", false);
                return;
            }

            const readers = archivos.map(file => {
                return new Promise(resolve => {
                    const reader = new FileReader();
                    reader.onload = e => resolve(e.target.result);
                    reader.readAsDataURL(file);
                });
            });
            Promise.all(readers).then(results => {
                for (let i = 0; i < titulos.length; i++) {
                    const titulo = titulos[i];
                    addBookToExistingSaga(currentSagaForAction, titulo, results[i] ? [results[i]] : []);
                }
            }).catch(e => {
                console.error("Error leyendo archivos:", e);
                showMessage("Hubo un error al leer los archivos de imagen.", false);
            });
        } else if (enlaces.length > 0) {
            for (let i = 0; i < titulos.length; i++) {
                const titulo = titulos[i];
                const link = enlaces[i];
                addBookToExistingSaga(currentSagaForAction, titulo, [link]);
            }
        } else {
            showMessage("Por favor, rellena los campos de título/enlace o selecciona un archivo de imagen.", false);
        }
    }

    function addBookToSaga(nombreSaga, autorSaga, titulo, images, enlaceSaga = '') {
        let sagaKey = Object.keys(sagas).find(k => k.toLowerCase() === nombreSaga.toLowerCase());

        if (!sagaKey) {
            sagaKey = nombreSaga.toLowerCase();
            sagas[sagaKey] = {
                nombre: capitalizeAllWords(nombreSaga),
                autor: capitalizeAllWords(autorSaga),
                link: enlaceSaga,
                libros: [],
                modificado: Date.now()
            };
        }

        const libroExistente = sagas[sagaKey].libros.find(l => l.titulo.toLowerCase() === titulo.toLowerCase());
        if (!libroExistente) {
            sagas[sagaKey].libros.push({
                titulo: capitalizeAllWords(titulo),
                img: images.length > 0 ? images : ['https://placehold.co/120x180/ccc/white?text=Libro'],
                estrellas: 0,
                leido: false,
            });
            sagas[sagaKey].modificado = Date.now();
            guardarSagas();
            renderSagas();
            cerrarModalAgregar();
            showMessage(`Se agregó el libro "${titulo}".`, false);
        } else {
            showMessage(`Ya existe un libro con el título "${titulo}" en esta saga.`, false);
        }
    }

    function addBookToExistingSaga(sagaKey, titulo, images) {
        const saga = sagas[sagaKey];
        const libroExistente = saga.libros.find(l => l.titulo.toLowerCase() === titulo.toLowerCase());
        if (!libroExistente) {
            saga.libros.push({
                titulo: capitalizeAllWords(titulo),
                img: images.length > 0 ? images : ['https://placehold.co/120x180/ccc/white?text=Libro'],
                estrellas: 0,
                leido: false,
            });
            saga.modificado = Date.now();
            guardarSagas();
            renderSagas();
            cerrarModalAgregarLibroExistente();
            showMessage(`Se agregó el libro "${titulo}" a la saga "${saga.nombre}".`, false);
        } else {
            showMessage(`Ya existe un libro con el título "${titulo}" en esta saga.`, false);
        }
    }

    function guardarEdicionLibro() {
        const nuevoTitulo = document.getElementById('editTitulo').value.trim();
        const nuevoImagenLink = document.getElementById('editImagenLink').value.trim();
        const nuevoImagenArchivo = document.getElementById('editImagenArchivo').files[0];

        if (!nuevoTitulo) {
            showMessage("El título no puede estar vacío.", false);
            return;
        }

        if (nuevoImagenArchivo) {
            if (nuevoImagenArchivo.size > 1000000) {
                showMessage("La imagen que intentas subir es demasiado grande. Por favor, comprímela o utiliza un enlace de imagen.", false);
                return;
            }
            const reader = new FileReader();
            reader.onload = e => {
                const libro = sagas[editSagaKey].libros[editBookIndex];
                libro.titulo = capitalizeAllWords(nuevoTitulo);
                libro.img = [e.target.result];
                sagas[editSagaKey].modificado = Date.now();
                guardarSagas();
                renderSagas();
                cerrarModalEditarLibro();
                showMessage(`Libro "${libro.titulo}" editado correctamente.`, false);
            };
            reader.readAsDataURL(nuevoImagenArchivo);
        } else {
            const libro = sagas[editSagaKey].libros[editBookIndex];
            libro.titulo = capitalizeAllWords(nuevoTitulo);
            if (nuevoImagenLink) {
                libro.img = [nuevoImagenLink];
            } else if (!nuevoImagenLink && !libro.img[0].startsWith('http')) {
                 libro.img = ['https://placehold.co/120x180/ccc/white?text=Libro'];
            }
            sagas[editSagaKey].modificado = Date.now();
            guardarSagas();
            renderSagas();
            cerrarModalEditarLibro();
            showMessage(`Libro "${libro.titulo}" editado correctamente.`, false);
        }
    }

    function guardarEdicionSaga() {
        const nuevoNombre = document.getElementById('editSagaNombre').value.trim();
        const nuevoAutor = document.getElementById('editSagaAutor').value.trim();
        const nuevoEnlace = document.getElementById('editSagaLink').value.trim();
        
        if (!nuevoNombre || !nuevoAutor) {
            showMessage("El nombre y el autor de la saga no pueden estar vacíos.", false);
            return;
        }

        const saga = sagas[currentSagaForAction];
        const oldKey = currentSagaForAction;
        const newKey = nuevoNombre.toLowerCase();

        if (oldKey !== newKey && sagas[newKey]) {
            showMessage("Ya existe una saga con ese nombre.", false);
            return;
        }

        saga.nombre = capitalizeAllWords(nuevoNombre);
        saga.autor = capitalizeAllWords(nuevoAutor);
        saga.link = nuevoEnlace;
        saga.modificado = Date.now();
        
        if (oldKey !== newKey) {
            sagas[newKey] = saga;
            delete sagas[oldKey];
        }

        guardarSagas();
        renderSagas();
        cerrarModalEditarSaga();
    }

    function eliminarLibro(sagaKey, index) {
        showConfirm("¿Estás seguro de que quieres eliminar este libro?", () => {
            sagas[sagaKey].libros.splice(index, 1);
            sagas[sagaKey].modificado = Date.now();
            if (sagas[sagaKey].libros.length === 0) {
                delete sagas[sagaKey];
            }
            guardarSagas();
            renderSagas();
            cerrarModalSeleccionarLibro();
        });
    }

    function eliminarSaga(sagaKey) {
        showConfirm(`¿Estás seguro de que quieres eliminar la saga "${sagas[sagaKey].nombre}" y todos sus libros? Esta acción es irreversible.`, () => {
            delete sagas[sagaKey];
            guardarSagas();
            renderSagas();
        });
    }
    
    // Función para recomendar el siguiente libro de una saga o un libro aleatorio no leído
    function recomendarSiguienteLibro() {
        const sagasEmpezadas = [];
        for (const sagaKey in sagas) {
            const saga = sagas[sagaKey];
            const librosLeidosEnSaga = saga.libros.filter(libro => libro.leido);
            const librosNoLeidosEnSaga = saga.libros.filter(libro => !libro.leido);
            
            // Si la saga tiene al menos un libro leído y uno no leído, es una saga "empezada"
            if (librosLeidosEnSaga.length > 0 && librosNoLeidosEnSaga.length > 0) {
                sagasEmpezadas.push({
                    saga: saga.nombre,
                    libroRecomendado: librosNoLeidosEnSaga[0].titulo
                });
            }
        }
        
        if (sagasEmpezadas.length > 0) {
            // Recomendar un libro de una saga ya empezada de forma aleatoria
            const recomendacion = sagasEmpezadas[Math.floor(Math.random() * sagasEmpezadas.length)];
            showMessage(`¡Excelente! Continúa con la saga "${recomendacion.saga}" leyendo "${recomendacion.libroRecomendado}".`, false);
            return;
        }

        // Si no hay sagas empezadas, buscar un libro no leído al azar
        const librosNoLeidos = [];
        for (const sagaKey in sagas) {
            const saga = sagas[sagaKey];
            const unreadBooksInSaga = saga.libros.filter(libro => !libro.leido);
            unreadBooksInSaga.forEach(libro => {
                librosNoLeidos.push({
                    titulo: libro.titulo,
                    saga: saga.nombre
                });
            });
        }

        if (librosNoLeidos.length === 0) {
            showMessage("¡Felicitaciones! Has leído todos los libros de tu estantería.", false);
            return;
        }

        const libroAleatorio = librosNoLeidos[Math.floor(Math.random() * librosNoLeidos.length)];
        showMessage(`¿Por qué no intentas leer "${libroAleatorio.titulo}" de la saga "${libroAleatorio.saga}"?`, false);
    }
    
    // Funcionalidad de Exportar/Importar
    function exportarSagas() {
        const dataStr = JSON.stringify(sagas, null, 2);
        const blob = new Blob([dataStr], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = "mi_estanteria_sagas.json";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importarSagas() {
        const fileInput = document.getElementById('importFile');
        const file = fileInput.files[0];
        if (!file) {
            showMessage("Por favor, selecciona un archivo para importar.", false);
            return;
        }

        showConfirm("¿Estás seguro de que quieres importar datos? Esto sobrescribirá toda tu estantería actual.", () => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    // Validar la estructura del objeto importado
                    if (typeof importedData === 'object' && importedData !== null && !Array.isArray(importedData)) {
                        sagas = importedData;
                        guardarSagas();
                        renderSagas();
                        showMessage("¡Datos importados correctamente!", false);
                    } else {
                        showMessage("Error al importar: el archivo JSON no tiene el formato esperado.", false);
                    }
                } catch (error) {
                    console.error("Error al importar el archivo:", error);
                    showMessage("Error al importar: el archivo no es un JSON válido.", false);
                }
            };
            reader.readAsText(file);
        });
    }

    function toggleVista() {
        const estanteriaEl = document.getElementById('estanteria');
        if (currentView === 'estanteria') {
            estanteriaEl.classList.add('vista-lista');
            currentView = 'lista';
        } else {
            estanteriaEl.classList.remove('vista-lista');
            currentView = 'estanteria';
        }
    }

    // --- Funciones de renderizado (UI) ---
    function renderSagas() {
        const estanteria = document.getElementById('estanteria');
        estanteria.innerHTML = '';
        
        const busqueda = document.getElementById('search').value.toLowerCase();
        const orden = document.getElementById('ordenSelect').value;
        
        let keysFiltradas = Object.keys(sagas).filter(sagaKey => {
            const saga = sagas[sagaKey];
            const textoBusqueda = `${saga.nombre} ${saga.autor}`.toLowerCase();
            const librosTexto = saga.libros.map(l => l.titulo.toLowerCase()).join(' ');
            return textoBusqueda.includes(busqueda) || librosTexto.includes(busqueda);
        });

        keysFiltradas.sort((a, b) => {
            const sagaA = sagas[a];
            const sagaB = sagas[b];
            if (orden === 'alfabetico') {
                return sagaA.nombre.localeCompare(sagaB.nombre);
            }
            return (sagaB.modificado || 0) - (sagaA.modificado || 0);
        });

        if (keysFiltradas.length === 0) {
            estanteria.innerHTML = `<p style="text-align:center; color:#888;">No hay sagas que coincidan con la búsqueda.</p>`;
        }

        keysFiltradas.forEach(sagaKey => {
            const saga = sagas[sagaKey];
            let promedioEstrellas = 0;
            const librosLeidos = saga.libros.filter(libro => libro.leido);
            if (librosLeidos.length > 0) {
                const totalEstrellas = librosLeidos.reduce((sum, libro) => sum + libro.estrellas, 0);
                promedioEstrellas = (totalEstrellas / librosLeidos.length).toFixed(1);
            } else {
                promedioEstrellas = "Sin calificar";
            }

            const contenedorSaga = document.createElement('div');
            contenedorSaga.className = 'saga';

            const tituloContenedor = document.createElement('div');
            tituloContenedor.className = 'saga-titulo';
            
            const titulo = document.createElement('h3');
            titulo.textContent = `${saga.nombre} | ${saga.autor} | ${promedioEstrellas} ★`;

            // Enlace de la saga
            const linkBtn = document.createElement('a');
            if (saga.link) {
                linkBtn.href = saga.link;
                linkBtn.target = "_blank";
                linkBtn.innerHTML = '&#127758;'; // Icono de mundo
                linkBtn.className = 'telegram-share-btn';
                tituloContenedor.appendChild(linkBtn);
            }

            // Menú de 3 puntos para toda la saga
            const menuDiv = document.createElement('div');
            menuDiv.className = 'saga-menu';
            menuDiv.innerHTML = `
                <button class="saga-menu-btn" onclick="this.nextElementSibling.classList.toggle('show')">&#x22EE;</button>
                <div class="saga-menu-content">
                    <a onclick="mostrarModalEditarSaga('${sagaKey}')">Editar saga</a>
                    <a onclick="mostrarModalAgregarLibroExistente('${sagaKey}')">Agregar libro</a>
                    <a onclick="eliminarSaga('${sagaKey}')">Eliminar saga</a>
                    <a onclick="mostrarModalSeleccionarLibro('${sagaKey}', 'editar')">Editar libro</a>
                    <a onclick="mostrarModalSeleccionarLibro('${sagaKey}', 'eliminar')">Eliminar libro</a>
                </div>
            `;
            
            tituloContenedor.appendChild(titulo);
            tituloContenedor.appendChild(menuDiv);
            contenedorSaga.appendChild(tituloContenedor);

            // Barra de progreso de la saga
            const totalLibros = saga.libros.length;
            const librosLeidosCount = saga.libros.filter(l => l.leido).length;
            const progresoPorcentaje = totalLibros > 0 ? (librosLeidosCount / totalLibros) * 100 : 0;
            const progressBarContainer = document.createElement('div');
            progressBarContainer.className = 'progress-bar-container';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressBar.style.width = `${progresoPorcentaje}%`;
            const progressText = document.createElement('span');
            progressText.className = 'progress-text';
            progressText.textContent = `${librosLeidosCount}/${totalLibros}`;
            progressBarContainer.appendChild(progressBar);
            progressBarContainer.appendChild(progressText);
            contenedorSaga.appendChild(progressBarContainer);

            const librosContenedor = document.createElement('div');
            librosContenedor.className = 'libros-contenedor';

            saga.libros.forEach((libro, index) => {
                const libroEntry = document.createElement('div');
                libroEntry.className = 'libro-entry';
                libroEntry.setAttribute('draggable', 'true');
                libroEntry.setAttribute('data-index', index);
                libroEntry.setAttribute('data-saga-key', sagaKey);

                libroEntry.addEventListener('dragstart', (e) => {
                    draggedBookInfo = { sagaKey: sagaKey, index: index };
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', JSON.stringify(draggedBookInfo));
                    setTimeout(() => libroEntry.classList.add('dragging'), 0);
                });
                libroEntry.addEventListener('dragend', () => {
                    libroEntry.classList.remove('dragging');
                });
                libroEntry.addEventListener('dragenter', (e) => {
                    e.preventDefault();
                    libroEntry.classList.add('drop-target');
                });
                libroEntry.addEventListener('dragleave', () => {
                    libroEntry.classList.remove('drop-target');
                });
                libroEntry.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });
                libroEntry.addEventListener('drop', (e) => {
                    e.preventDefault();
                    libroEntry.classList.remove('drop-target');
                    if (draggedBookInfo && draggedBookInfo.sagaKey === sagaKey) {
                        const fromIndex = draggedBookInfo.index;
                        const toIndex = index;
                        if (fromIndex !== toIndex) {
                            const [movedBook] = sagas[sagaKey].libros.splice(fromIndex, 1);
                            sagas[sagaKey].libros.splice(toIndex, 0, movedBook);
                            sagas[sagaKey].modificado = Date.now();
                            guardarSagas();
                            renderSagas();
                        }
                    }
                });
                
                const libroDiv = document.createElement('div');
                libroDiv.className = 'libro' + (libro.leido ? '' : ' libro-no-leido');

                const primaryImage = Array.isArray(libro.img) && libro.img.length > 0 ? libro.img[0] : 'https://placehold.co/120x180/ccc/white?text=Libro';
                libroDiv.innerHTML = `
                    <img src="${primaryImage}" alt="Portada de ${libro.titulo}" class="libro-img">
                    ${libro.leido ? '<div class="leido-indicador">✔</div>' : ''}
                `;

                const libroTitulo = document.createElement('p');
                libroTitulo.className = 'libro-titulo';
                libroTitulo.textContent = libro.titulo;

                const estrellasContenedor = document.createElement('div');
                estrellasContenedor.className = 'estrellas';
                estrellasContenedor.setAttribute('data-index', index);
                
                let clickTimer = null;
                let clickCount = 0;

                estrellasContenedor.addEventListener('click', (event) => {
                    const targetStar = event.target.closest('.estrella');
                    if (!targetStar) return;

                    const allStars = Array.from(estrellasContenedor.children);
                    const clickedStarIndex = allStars.indexOf(targetStar) + 1;

                    clickCount++;
                    clearTimeout(clickTimer);

                    if (clickCount === 1) {
                        clickTimer = setTimeout(() => {
                            libro.estrellas = clickedStarIndex;
                            libro.leido = true;
                            saga.libros[index] = libro;
                            saga.modificado = Date.now();
                            guardarSagas();
                            renderSagas();
                            clickCount = 0;
                        }, 300);
                    } else if (clickCount === 2) {
                        clearTimeout(clickTimer);
                        libro.estrellas = clickedStarIndex - 0.5;
                        libro.leido = true;
                        saga.libros[index] = libro;
                        saga.modificado = Date.now();
                        guardarSagas();
                        renderSagas();
                        clickCount = 0;
                    } else if (clickCount >= 3) {
                        clearTimeout(clickTimer);
                        showConfirm("¿Estás seguro de que quieres eliminar la puntuación de este libro?", () => {
                            libro.estrellas = 0;
                            libro.leido = false;
                            saga.libros[index] = libro;
                            saga.modificado = Date.now();
                            guardarSagas();
                            renderSagas();
                        });
                        clickCount = 0;
                    }
                });

                for (let i = 1; i <= 5; i++) {
                    const estrellaSpan = document.createElement('span');
                    if (libro.estrellas >= i) {
                        estrellaSpan.innerHTML = '★';
                    } else if (libro.estrellas >= i - 0.5) {
                        estrellaSpan.innerHTML = '½';
                    } else {
                        estrellaSpan.innerHTML = '☆';
                    }
                    estrellaSpan.className = 'estrella';
                    estrellasContenedor.appendChild(estrellaSpan);
                }

                libroEntry.appendChild(libroDiv);
                libroEntry.appendChild(libroTitulo);
                libroEntry.appendChild(estrellasContenedor);
                librosContenedor.appendChild(libroEntry);
            });
            contenedorSaga.appendChild(librosContenedor);
            estanteria.appendChild(contenedorSaga);
        });
        
        if (currentView === 'lista') {
            estanteria.classList.add('vista-lista');
        } else {
            estanteria.classList.remove('vista-lista');
        }
    }

    // --- Funciones de modal personalizadas ---
    function showMessage(message, isConfirmation = false, onConfirm = null) {
        const modal = document.getElementById('customModal');
        const modalMessage = document.getElementById('modalMessage');
        const okBtn = document.getElementById('modalOkBtn');
        const cancelBtn = document.getElementById('modalCancelBtn');

        modalMessage.textContent = message;
        
        okBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'none';

        if (isConfirmation) {
            cancelBtn.style.display = 'inline-block';
            okBtn.onclick = () => {
                onConfirm();
                modal.style.display = 'none';
            };
            cancelBtn.onclick = () => {
                modal.style.display = 'none';
            };
        } else {
            okBtn.onclick = () => {
                modal.style.display = 'none';
            };
        }

        modal.style.display = 'flex';
    }

    function showConfirm(message, onConfirm) {
        showMessage(message, true, onConfirm);
    }
    
    renderSagas();
</script>

</body>
</html>
