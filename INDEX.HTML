<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestor de Lectura</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .star-rating {
            display: flex;
            flex-direction: row-reverse;
            justify-content: flex-end;
            align-items: center;
        }
        .star-rating input[type="radio"] {
            display: none;
        }
        .star-rating label {
            font-size: 1.5rem;
            color: #ddd;
            padding: 0 0.1rem;
            cursor: pointer;
        }
        .star-rating label:hover,
        .star-rating label:hover ~ label {
            color: #ffc107;
        }
        .star-rating input[type="radio"]:checked ~ label {
            color: #ffc107;
        }
        .book-card .cover-image.unread {
            filter: brightness(50%);
        }
        .suggestion-list {
            list-style: none;
            padding: 0;
            margin: 0;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: absolute;
            width: 100%;
            z-index: 10;
        }
        .suggestion-list li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .suggestion-list li:hover {
            background-color: #f3f4f6;
        }
        .suggestion-list li:not(:last-child) {
            border-bottom: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container py-8">
        <div class="bg-white p-8 rounded-xl shadow-lg">
            <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">Gestor de Lectura</h1>
            <p class="text-center text-gray-500 mb-6">Gestiona tus libros y sagas fácilmente.</p>

            <!-- Sección de estadísticas -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-blue-100 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-sm font-semibold text-blue-800">Total de Libros</h2>
                    <p id="totalBooks" class="text-2xl font-bold text-blue-600 mt-2">0</p>
                </div>
                <div class="bg-green-100 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-sm font-semibold text-green-800">Libros Leídos</h2>
                    <p id="readBooks" class="text-2xl font-bold text-green-600 mt-2">0</p>
                </div>
                <div class="bg-purple-100 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-sm font-semibold text-purple-800">Total de Sagas</h2>
                    <p id="totalSagas" class="text-2xl font-bold text-purple-600 mt-2">0</p>
                </div>
                <div class="bg-yellow-100 p-4 rounded-lg shadow-sm text-center">
                    <h2 class="text-sm font-semibold text-yellow-800">Sagas Terminadas</h2>
                    <p id="finishedSagas" class="text-2xl font-bold text-yellow-600 mt-2">0</p>
                </div>
            </div>
            
            <!-- Panel de lectura personalizado -->
            <div class="bg-indigo-100 p-6 rounded-lg shadow-inner mb-8">
                <h3 class="text-2xl font-semibold text-indigo-800 mb-4">Mi Progreso de Lectura</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <h4 class="text-sm font-semibold text-gray-700">Páginas Leídas</h4>
                        <p id="pagesRead" class="text-2xl font-bold text-indigo-600 mt-2">0</p>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-sm text-center">
                        <h4 class="text-sm font-semibold text-gray-700">Libros leídos (últimos 30 días)</h4>
                        <p id="booksLast30Days" class="text-2xl font-bold text-indigo-600 mt-2">0</p>
                    </div>
                </div>
            </div>

            <!-- Formularios para agregar -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <div class="grid grid-cols-1 gap-6">
                    <!-- Formulario de libro -->
                    <div>
                        <h3 class="text-2xl font-semibold text-gray-700 mb-4">Agregar Nuevo Libro</h3>
                        <form id="bookForm" class="space-y-4">
                            <div>
                                <label for="bookTitle" class="block text-gray-700 font-medium mb-1">Título</label>
                                <input type="text" id="bookTitle" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: El señor de los anillos" required>
                            </div>
                            <div>
                                <label for="bookAuthor" class="block text-gray-700 font-medium mb-1">Autor</label>
                                <input type="text" id="bookAuthor" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: J.R.R. Tolkien">
                            </div>
                            <!-- Botón para buscar datos -->
                            <button type="button" id="searchBookBtn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition duration-300">
                                Buscar Datos del Libro
                            </button>
                            <p id="searchStatus" class="text-center text-sm text-gray-500 mt-2"></p>
                            
                            <div>
                                <label for="bookCoverUrl" class="block text-gray-700 font-medium mb-1">URL de la Portada</label>
                                <input type="url" id="bookCoverUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: https://ejemplo.com/portada.jpg">
                            </div>
                            <div>
                                <label for="bookImageFile" class="block text-gray-700 font-medium mb-1">O sube un archivo</label>
                                <input type="file" id="bookImageFile" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label for="bookPages" class="block text-gray-700 font-medium mb-1">Número de páginas</label>
                                <input type="number" id="bookPages" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: 420">
                            </div>
                             <div>
                                <label for="bookRecommendedBy" class="block text-gray-700 font-medium mb-1">Recomendado por</label>
                                <input type="text" id="bookRecommendedBy" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ej: Amigo, Twitter, Podcast">
                            </div>
                            <div>
                                <label for="bookSynopsis" class="block text-gray-700 font-medium mb-1">Sinopsis</label>
                                <textarea id="bookSynopsis" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Breve resumen del libro"></textarea>
                            </div>
                            <div>
                                <label for="sagaSelect" class="block text-gray-700 font-medium mb-1">Asignar a Saga</label>
                                <select id="sagaSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="none">Ninguna saga</option>
                                    <option value="new_saga">Crear nueva saga</option>
                                </select>
                            </div>
                            <div id="newSagaNameContainer" class="hidden">
                                <label for="newSagaName" class="block text-gray-700 font-medium mb-1">Nombre de la Nueva Saga</label>
                                <input type="text" id="newSagaName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500" placeholder="Ej: El Señor de los Anillos">
                            </div>
                            <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Agregar Libro</button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Sección de búsqueda, filtros y ordenación -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-inner mb-8">
                <div class="relative w-full mb-4">
                    <input type="text" id="searchInput" placeholder="Buscar por título, autor o sinopsis..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <ul id="suggestionList" class="suggestion-list hidden"></ul>
                </div>

                <div class="flex flex-col sm:flex-row items-center gap-4">
                    <div class="flex-grow flex items-center justify-center sm:justify-start gap-2 flex-wrap">
                        <span class="text-gray-700 font-medium">Filtrar:</span>
                        <button id="filterAll" class="px-4 py-2 rounded-full text-sm font-semibold transition duration-300 bg-blue-600 text-white shadow-md">Todos</button>
                        <button id="filterRead" class="px-4 py-2 rounded-full text-sm font-semibold transition duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">Leídos</button>
                        <button id="filterUnread" class="px-4 py-2 rounded-full text-sm font-semibold transition duration-300 bg-gray-200 text-gray-700 hover:bg-gray-300">No leídos</button>
                    </div>

                    <div class="flex items-center gap-2 mt-4 sm:mt-0">
                        <span class="text-gray-700 font-medium">Ordenar:</span>
                        <select id="sortSelect" class="w-40 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            <option value="title-asc">Título (A-Z)</option>
                            <option value="title-desc">Título (Z-A)</option>
                            <option value="author-asc">Autor (A-Z)</option>
                            <option value="author-desc">Autor (Z-A)</option>
                            <option value="rating-desc">Calificación (Mayor a menor)</option>
                            <option value="rating-asc">Calificación (Menor a mayor)</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sección de libros y sagas -->
            <h3 class="text-2xl font-semibold text-gray-700 mb-4">Mis Libros y Sagas</h3>
            <div id="bookAndSagasList" class="space-y-8">
                <!-- Sagas y libros se renderizarán aquí -->
            </div>
            
        </div>

        <!-- ID de usuario -->
        <div class="mt-6 text-center text-sm text-gray-500">
            <p>ID de Usuario: <span id="userIdDisplay" class="font-mono bg-gray-200 px-2 py-1 rounded-md">Cargando...</span></p>
        </div>
        
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, addDoc, onSnapshot, updateDoc, deleteDoc, getDocs, where, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales proporcionadas por el entorno. No las modifiques.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // ** REEMPLAZA ESTA CLAVE CON TU CLAVE DE API DE GOOGLE BOOKS **
        const GOOGLE_BOOKS_API_KEY = "";

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let allBooks = [];
        let allSagas = [];
        let currentSearch = '';
        let currentFilter = 'all';
        let currentSort = 'title-asc';
        let bulkDeleteState = {
            sagaId: null,
            selectedBooks: new Set()
        };

        // Referencias del DOM
        const userIdDisplay = document.getElementById('userIdDisplay');
        const totalBooksDisplay = document.getElementById('totalBooks');
        const readBooksDisplay = document.getElementById('readBooks');
        const totalSagasDisplay = document.getElementById('totalSagas');
        const finishedSagasDisplay = document.getElementById('finishedSagas');
        const bookAndSagasList = document.getElementById('bookAndSagasList');
        const bookForm = document.getElementById('bookForm');
        const sagaSelect = document.getElementById('sagaSelect');
        const newSagaNameContainer = document.getElementById('newSagaNameContainer');
        const newSagaNameInput = document.getElementById('newSagaName');
        const bookImageFile = document.getElementById('bookImageFile');
        const searchInput = document.getElementById('searchInput');
        const suggestionList = document.getElementById('suggestionList');
        const filterAllBtn = document.getElementById('filterAll');
        const filterReadBtn = document.getElementById('filterRead');
        const filterUnreadBtn = document.getElementById('filterUnread');
        const sortSelect = document.getElementById('sortSelect');
        const searchBookBtn = document.getElementById('searchBookBtn');
        const searchStatus = document.getElementById('searchStatus');
        const bookTitleInput = document.getElementById('bookTitle');
        const bookAuthorInput = document.getElementById('bookAuthor');
        const bookCoverUrlInput = document.getElementById('bookCoverUrl');
        const bookPagesInput = document.getElementById('bookPages');
        const bookSynopsisInput = document.getElementById('bookSynopsis');
        const bookRecommendedByInput = document.getElementById('bookRecommendedBy'); // Nueva referencia
        const pagesReadDisplay = document.getElementById('pagesRead');
        const booksLast30DaysDisplay = document.getElementById('booksLast30Days');


        // Función para manejar el inicio de sesión
        async function signIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Error al iniciar sesión:", error);
            }
        }

        // Oyente de estado de autenticación
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                userIdDisplay.textContent = userId;
                setupFirestoreListeners();
            } else {
                userId = null;
                userIdDisplay.textContent = 'No autenticado';
                await signIn();
            }
        });

        // Oyente para sugerencias de búsqueda
        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            if (query.length > 1) {
                const suggestions = allBooks.filter(book => 
                    book.title.toLowerCase().includes(query) || 
                    (book.author && book.author.toLowerCase().includes(query))
                ).slice(0, 5); // Limitar a 5 sugerencias

                if (suggestions.length > 0) {
                    renderSuggestions(suggestions);
                } else {
                    suggestionList.classList.add('hidden');
                }
            } else {
                suggestionList.classList.add('hidden');
            }
            currentSearch = query;
            filterAndSortAndRender();
        });

        function renderSuggestions(suggestions) {
            suggestionList.innerHTML = '';
            suggestions.forEach(book => {
                const li = document.createElement('li');
                li.textContent = `${book.title} - ${book.author || 'Autor desconocido'}`;
                li.onclick = () => {
                    searchInput.value = book.title;
                    currentSearch = book.title.toLowerCase();
                    suggestionList.classList.add('hidden');
                    filterAndSortAndRender();
                };
                suggestionList.appendChild(li);
            });
            suggestionList.classList.remove('hidden');
        }

        // Oyentes para búsqueda, filtro y ordenación
        filterAllBtn.addEventListener('click', () => {
            currentFilter = 'all';
            updateFilterButtons();
            filterAndSortAndRender();
        });

        filterReadBtn.addEventListener('click', () => {
            currentFilter = 'read';
            updateFilterButtons();
            filterAndSortAndRender();
        });

        filterUnreadBtn.addEventListener('click', () => {
            currentFilter = 'unread';
            updateFilterButtons();
            filterAndSortAndRender();
        });

        sortSelect.addEventListener('change', (e) => {
            currentSort = e.target.value;
            filterAndSortAndRender();
        });
        
        // Oyente para buscar datos del libro
        searchBookBtn.addEventListener('click', async () => {
            const title = bookTitleInput.value;
            const author = bookAuthorInput.value;

            if (title === '' && author === '') {
                searchStatus.textContent = 'Por favor, introduce al menos un título o un autor.';
                return;
            }

            searchStatus.textContent = 'Buscando...';
            searchBookBtn.disabled = true;

            try {
                const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${title ? `intitle:${title}` : ''}${author ? `+inauthor:${author}` : ''}&key=${GOOGLE_BOOKS_API_KEY}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    const bookInfo = data.items[0].volumeInfo;
                    bookCoverUrlInput.value = bookInfo.imageLinks?.thumbnail || '';
                    bookAuthorInput.value = bookInfo.authors?.join(', ') || '';
                    bookPagesInput.value = bookInfo.pageCount || '';
                    bookSynopsisInput.value = bookInfo.description || '';
                    searchStatus.textContent = 'Datos encontrados y rellenados.';
                } else {
                    searchStatus.textContent = 'No se encontraron resultados. Por favor, revisa el título o autor.';
                }
            } catch (error) {
                console.error("Error al buscar el libro:", error);
                searchStatus.textContent = 'Error al buscar. Intenta de nuevo más tarde.';
            } finally {
                searchBookBtn.disabled = false;
            }
        });

        // Actualiza el estilo del botón de filtro activo
        function updateFilterButtons() {
            const buttons = [filterAllBtn, filterReadBtn, filterUnreadBtn];
            buttons.forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'hover:bg-gray-300');
                btn.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
            });

            if (currentFilter === 'all') {
                filterAllBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                filterAllBtn.classList.add('bg-blue-600', 'text-white');
            } else if (currentFilter === 'read') {
                filterReadBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                filterReadBtn.classList.add('bg-blue-600', 'text-white');
            } else if (currentFilter === 'unread') {
                filterUnreadBtn.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
                filterUnreadBtn.classList.add('bg-blue-600', 'text-white');
            }
        }

        sagaSelect.addEventListener('change', (e) => {
            if (e.target.value === 'new_saga') {
                newSagaNameContainer.classList.remove('hidden');
            } else {
                newSagaNameContainer.classList.add('hidden');
            }
        });

        function setupFirestoreListeners() {
            const booksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/books`);
            const sagasCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/sagas`);

            // Oyente para sagas
            onSnapshot(sagasCollectionRef, (snapshot) => {
                allSagas = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const total = allSagas.length;
                const finished = allSagas.filter(saga => saga.status === 'finished').length;
                totalSagasDisplay.textContent = total;
                finishedSagasDisplay.textContent = finished;
                populateSagaSelect(allSagas);
                filterAndSortAndRender();
            }, (error) => {
                console.error("Error al obtener las sagas:", error);
            });

            // Oyente para libros
            onSnapshot(booksCollectionRef, (snapshot) => {
                allBooks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Actualizar estadísticas del panel personalizado
                let totalPagesRead = 0;
                let booksReadLast30Days = 0;
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                allBooks.forEach(book => {
                    if (book.isRead) {
                        totalPagesRead += book.pageCount || 0;
                        if (book.finishedAt && book.finishedAt.toDate() > thirtyDaysAgo) {
                            booksReadLast30Days++;
                        }
                    }
                });
                
                totalBooksDisplay.textContent = allBooks.length;
                readBooksDisplay.textContent = allBooks.filter(book => book.isRead).length;
                pagesReadDisplay.textContent = totalPagesRead;
                booksLast30DaysDisplay.textContent = booksReadLast30Days;
                
                filterAndSortAndRender();
            }, (error) => {
                console.error("Error al obtener los libros:", error);
            });
        }
        
        // Función principal para filtrar, ordenar y renderizar
        function filterAndSortAndRender() {
            // Filtrar los libros
            let filteredBooks = allBooks.filter(book => {
                const searchLower = currentSearch.toLowerCase();
                const matchesSearch = book.title.toLowerCase().includes(searchLower) || 
                                      (book.author && book.author.toLowerCase().includes(searchLower)) ||
                                      (book.synopsis && book.synopsis.toLowerCase().includes(searchLower));
                const matchesReadFilter = currentFilter === 'all' || 
                                          (currentFilter === 'read' && book.isRead) || 
                                          (currentFilter === 'unread' && !book.isRead);
                
                return matchesSearch && matchesReadFilter;
            });
            
            // Ordenar los libros
            filteredBooks.sort((a, b) => {
                switch (currentSort) {
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    case 'author-asc':
                        return (a.author || '').localeCompare(b.author || '');
                    case 'author-desc':
                        return (b.author || '').localeCompare(a.author || '');
                    case 'rating-desc':
                        return (b.rating || 0) - (a.rating || 0);
                    case 'rating-asc':
                        return (a.rating || 0) - (b.rating || 0);
                    default:
                        return 0;
                }
            });
            
            renderBooksAndSagas(filteredBooks, allSagas);
        }

        function populateSagaSelect(sagas) {
            sagaSelect.innerHTML = '<option value="none">Ninguna saga</option><option value="new_saga">Crear nueva saga</option>';
            sagas.forEach(saga => {
                const option = document.createElement('option');
                option.value = saga.id;
                option.textContent = saga.name;
                sagaSelect.appendChild(option);
            });
        }

        function renderStars(rating, bookId) {
            let starsHtml = '';
            for (let i = 5; i >= 1; i--) {
                const checked = i === rating ? 'checked' : '';
                const starColorClass = i <= rating ? 'text-yellow-400' : 'text-gray-300';
                starsHtml += `
                    <input type="radio" id="star-${bookId}-${i}" name="rating-${bookId}" value="${i}" class="hidden" 
                           onclick="window.updateBookRating('${bookId}', ${i})" />
                    <label for="star-${bookId}-${i}" title="${i} estrellas" class="${starColorClass} cursor-pointer text-2xl">★</label>
                `;
            }
            return starsHtml;
        }

        // Nueva función para renderizar libros agrupados por saga
        function renderBooksAndSagas(books, sagas) {
            bookAndSagasList.innerHTML = '';
            const booksBySaga = books.reduce((acc, book) => {
                const sagaId = book.sagaId || 'none';
                if (!acc[sagaId]) {
                    acc[sagaId] = [];
                }
                acc[sagaId].push(book);
                return acc;
            }, {});

            const sortedSagas = [...sagas].sort((a, b) => a.name.localeCompare(b.name));

            // Renderizar sagas
            sortedSagas.forEach(saga => {
                const sagaBooks = booksBySaga[saga.id] || [];
                if (sagaBooks.length > 0) {
                    const ratedBooks = sagaBooks.filter(b => b.rating > 0);
                    const avgRating = ratedBooks.length > 0 ? (ratedBooks.reduce((sum, b) => sum + b.rating, 0) / ratedBooks.length).toFixed(1) : 'Sin calificación';
                    const author = sagaBooks[0].author || 'Autor desconocido';

                    const sagaContainer = document.createElement('div');
                    sagaContainer.className = 'bg-white p-6 rounded-lg shadow-md mb-6';

                    let sagaHeaderContent = '';
                    if (bulkDeleteState.sagaId === saga.id) {
                        sagaHeaderContent = `
                            <div class="flex justify-between items-center mb-4">
                                <h4 class="font-bold text-lg text-red-600">Modo de Eliminación: ${saga.name}</h4>
                                <div class="flex space-x-2">
                                    <button onclick="window.confirmBulkDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg shadow-md hover:bg-red-700 transition duration-300">
                                        Confirmar Eliminación (${bulkDeleteState.selectedBooks.size})
                                    </button>
                                    <button onclick="window.cancelBulkDelete()" class="px-4 py-2 bg-gray-400 text-gray-800 rounded-lg shadow-md hover:bg-gray-500 transition duration-300">
                                        Cancelar
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        sagaHeaderContent = `
                            <div class="flex justify-between items-center mb-4">
                                <div class="flex items-center space-x-2 text-gray-800">
                                    <h4 class="font-bold text-lg text-purple-600">${saga.name}</h4>
                                    <span class="text-gray-400">|</span>
                                    <p class="text-sm">Por: ${author}</p>
                                    <span class="text-gray-400">|</span>
                                    <div class="flex items-center text-sm">
                                        <span class="font-bold">${avgRating}</span>
                                        <span class="text-yellow-400 ml-1">★</span>
                                    </div>
                                </div>
                                <div class="relative">
                                    <button onclick="window.toggleSagaMenu('${saga.id}', event)" class="text-gray-500 hover:text-gray-700">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                                            <path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z" />
                                        </svg>
                                    </button>
                                    <div id="menu-${saga.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                                        <a href="#" onclick="window.deleteSaga('${saga.id}')" class="block px-4 py-2 text-sm text-red-700 hover:bg-gray-100">Eliminar Saga y sus libros</a>
                                        <a href="#" onclick="window.startBulkDelete('${saga.id}')" class="block px-4 py-2 text-sm text-red-700 hover:bg-gray-100">Eliminar libros seleccionados</a>
                                        <a href="#" onclick="window.updateSagaStatus('${saga.id}', 'finished')" class="block px-4 py-2 text-sm text-green-700 hover:bg-gray-100">Marcar como terminada</a>
                                        <a href="#" onclick="window.updateSagaStatus('${saga.id}', 'abandoned')" class="block px-4 py-2 text-sm text-yellow-700 hover:bg-gray-100">Marcar como abandonada</a>
                                        <a href="#" onclick="window.addBookToSaga('${saga.id}')" class="block px-4 py-2 text-sm text-blue-700 hover:bg-gray-100">Agregar libro</a>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                    
                    sagaContainer.innerHTML += sagaHeaderContent + `
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                            ${sagaBooks.map(book => createBookCard(book, bulkDeleteState.sagaId === saga.id)).join('')}
                        </div>
                    `;
                    bookAndSagasList.appendChild(sagaContainer);
                }
            });

            // Renderizar libros sin saga
            const noSagaBooks = booksBySaga['none'] || [];
            if (noSagaBooks.length > 0) {
                const noSagaContainer = document.createElement('div');
                noSagaContainer.className = 'bg-white p-6 rounded-lg shadow-md';
                noSagaContainer.innerHTML = `
                    <h4 class="text-xl font-bold text-gray-700 mb-4">Libros sin saga</h4>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                        ${noSagaBooks.map(book => createBookCard(book, false)).join('')}
                    </div>
                `;
                bookAndSagasList.appendChild(noSagaContainer);
            }
        }

        // Crea la tarjeta de un libro para el renderizado
        function createBookCard(book, isBulkDeleteMode) {
            const coverSrc = book.coverBase64 || book.coverUrl || 'https://placehold.co/150x200/94a3b8/e2e8f0?text=Sin+Portada';
            const readStatusText = book.isRead ? 'Marcar como no leído' : 'Marcar como leído';
            const isSelected = isBulkDeleteMode && bulkDeleteState.selectedBooks.has(book.id);
            
            let actionHtml = '';
            if (isBulkDeleteMode) {
                actionHtml = `
                    <div class="absolute top-2 left-2">
                        <input type="checkbox" onchange="window.toggleBookSelection('${book.id}')" ${isSelected ? 'checked' : ''} class="w-5 h-5 text-red-600 bg-gray-100 border-gray-300 rounded focus:ring-red-500">
                    </div>
                `;
            } else {
                actionHtml = `
                    <div class="absolute top-2 right-2">
                        <button onclick="window.toggleBookMenu('${book.id}', event)" class="text-gray-500 hover:text-gray-700 bg-white rounded-full p-1 shadow">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4zm0 6a2 2 0 110-4 2 2 0 010 4z" />
                            </svg>
                        </button>
                        <div id="book-menu-${book.id}" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-10">
                            <a href="#" onclick="window.toggleReadStatus('${book.id}', ${!book.isRead})" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">${readStatusText}</a>
                            <a href="#" onclick="window.deleteItem('${book.id}', true)" class="block px-4 py-2 text-sm text-red-700 hover:bg-gray-100">Eliminar libro</a>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="p-3 rounded-lg shadow-sm transition transform hover:scale-105 duration-200 ${book.isRead ? 'bg-green-50' : 'bg-gray-200'} book-card">
                    <div class="relative">
                        <img src="${coverSrc}" alt="Portada del libro" class="h-40 w-full object-cover rounded-md mb-2 cover-image ${!book.isRead ? 'unread' : ''}">
                        ${actionHtml}
                    </div>
                    <div class="mt-2 text-sm">
                        <h4 class="font-semibold truncate text-gray-800">${book.title}</h4>
                         ${book.recommendedBy ? `<p class="text-xs text-gray-500 mt-1">Recomendado por: ${book.recommendedBy}</p>` : ''}
                    </div>
                    <div class="mt-2 flex justify-start items-center">
                        <div class="star-rating">
                            ${renderStars(book.rating, book.id)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Toggle del menú de la saga
        window.toggleSagaMenu = (sagaId, event) => {
            event.stopPropagation();
            const menu = document.getElementById(`menu-${sagaId}`);
            if (menu) {
                menu.classList.toggle('hidden');
            }
        };

        // Toggle del menú del libro
        window.toggleBookMenu = (bookId, event) => {
            event.stopPropagation();
            const menu = document.getElementById(`book-menu-${bookId}`);
            if (menu) {
                menu.classList.toggle('hidden');
            }
        };

        // Escucha clics fuera de los menús para cerrarlos
        document.addEventListener('click', (event) => {
            document.querySelectorAll('[id^="menu-"]').forEach(menu => {
                if (!menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
            document.querySelectorAll('[id^="book-menu-"]').forEach(menu => {
                if (!menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        });

        // Activa el modo de eliminación masiva
        window.startBulkDelete = (sagaId) => {
            bulkDeleteState.sagaId = sagaId;
            bulkDeleteState.selectedBooks.clear();
            filterAndSortAndRender();
        };

        // Cancela el modo de eliminación masiva
        window.cancelBulkDelete = () => {
            bulkDeleteState.sagaId = null;
            bulkDeleteState.selectedBooks.clear();
            filterAndSortAndRender();
        };

        // Maneja la selección de libros para eliminación masiva
        window.toggleBookSelection = (bookId) => {
            if (bulkDeleteState.selectedBooks.has(bookId)) {
                bulkDeleteState.selectedBooks.delete(bookId);
            } else {
                bulkDeleteState.selectedBooks.add(bookId);
            }
            filterAndSortAndRender();
        };
        
        // Ejecuta la eliminación masiva de los libros seleccionados
        window.confirmBulkDelete = async () => {
            if (bulkDeleteState.selectedBooks.size === 0) {
                 // Reemplazar la alerta con un modal o confirmación visual si es necesario
                console.log("No has seleccionado ningún libro para eliminar.");
                window.cancelBulkDelete();
                return;
            }

            // Reemplazar la alerta con un modal o confirmación visual si es necesario
            if (window.confirm(`¿Estás seguro de que quieres eliminar ${bulkDeleteState.selectedBooks.size} libro(s)?`)) {
                const deletePromises = [];
                bulkDeleteState.selectedBooks.forEach(bookId => {
                    deletePromises.push(window.deleteItem(bookId, true));
                });
                await Promise.all(deletePromises);
                window.cancelBulkDelete();
            }
        };

        // Agregar nuevo libro y/o saga
        bookForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookTitle = bookForm.bookTitle.value;
            const bookAuthor = bookForm.bookAuthor.value;
            const bookCoverUrl = bookForm.bookCoverUrl.value;
            const bookImageFile = bookForm.bookImageFile.files[0];
            const bookPages = parseInt(bookForm.bookPages.value, 10);
            const bookSynopsis = bookForm.bookSynopsis.value;
            const bookRecommendedBy = bookForm.bookRecommendedBy.value; // Obtener el "Recomendado por"
            const sagaSelection = sagaSelect.value;

            if (!userId) {
                console.error("Usuario no autenticado, no se puede agregar el libro.");
                return;
            }

            let sagaId = null;
            let bookCoverBase64 = null;

            if (sagaSelection === 'new_saga') {
                const newSagaName = newSagaNameInput.value;
                if (newSagaName.trim() === '') {
                    console.error('Por favor, ingresa el nombre de la nueva saga.');
                    return;
                }
                try {
                    const newSagaRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sagas`), {
                        name: newSagaName,
                        status: 'in_progress',
                        createdAt: new Date()
                    });
                    sagaId = newSagaRef.id;
                } catch (error) {
                    console.error("Error al crear la nueva saga:", error);
                    return;
                }
            } else if (sagaSelection !== 'none') {
                sagaId = sagaSelection;
            }

            const bookData = {
                title: bookTitle,
                author: bookAuthor,
                pageCount: bookPages,
                synopsis: bookSynopsis,
                recommendedBy: bookRecommendedBy, // Añadir el campo
                sagaId: sagaId,
                isRead: false,
                rating: 0,
                createdAt: new Date()
            };

            if (bookImageFile) {
                const reader = new FileReader();
                reader.onload = async (event) => {
                    bookData.coverBase64 = event.target.result;
                    try {
                        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/books`), bookData);
                        bookForm.reset();
                        newSagaNameContainer.classList.add('hidden');
                        sagaSelect.value = 'none';
                    } catch (error) {
                        console.error("Error al agregar el libro con imagen:", error);
                    }
                };
                reader.readAsDataURL(bookImageFile);
            } else {
                bookData.coverUrl = bookCoverUrl;
                try {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/books`), bookData);
                    bookForm.reset();
                    newSagaNameContainer.classList.add('hidden');
                    sagaSelect.value = 'none';
                } catch (error) {
                    console.error("Error al agregar el libro:", error);
                }
            }
        });

        window.toggleReadStatus = async (bookId, isRead) => {
            const bookRef = doc(db, `artifacts/${appId}/users/${userId}/books`, bookId);
            try {
                const updateData = { isRead: isRead };
                if (isRead) {
                    updateData.finishedAt = new Date();
                }
                await updateDoc(bookRef, updateData);
            } catch (error) {
                console.error("Error al actualizar el estado de lectura:", error);
            }
        };

        window.updateBookRating = async (bookId, newRating) => {
            const bookRef = doc(db, `artifacts/${appId}/users/${userId}/books`, bookId);
            try {
                await updateDoc(bookRef, { rating: newRating });
            } catch (error) {
                console.error("Error al actualizar la calificación:", error);
            }
        };

        window.deleteItem = async (docId, isBook) => {
            const collectionPath = isBook ? `artifacts/${appId}/users/${userId}/books` : `artifacts/${appId}/users/${userId}/sagas`;
            const docRef = doc(db, collectionPath, docId);
            try {
                await deleteDoc(docRef);
            } catch (error) {
                console.error("Error al eliminar el elemento:", error);
            }
        };

        // Eliminar saga y todos sus libros
        window.deleteSaga = async (sagaId) => {
            if (window.confirm("¿Estás seguro de que quieres eliminar esta saga y todos sus libros?")) {
                const booksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/books`);
                const q = query(booksCollectionRef, where("sagaId", "==", sagaId));
                const booksSnapshot = await getDocs(q);
                booksSnapshot.forEach(async (bookDoc) => {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/books`, bookDoc.id));
                });
                const sagaRef = doc(db, `artifacts/${appId}/users/${userId}/sagas`, sagaId);
                await deleteDoc(sagaRef);
            }
        };

        // Actualizar el estado de la saga
        window.updateSagaStatus = async (sagaId, status) => {
            const sagaRef = doc(db, `artifacts/${appId}/users/${userId}/sagas`, sagaId);
            try {
                await updateDoc(sagaRef, { status: status });
            } catch (error) {
                console.error("Error al actualizar el estado de la saga:", error);
            }
        };

        window.addBookToSaga = (sagaId) => {
            document.getElementById('sagaSelect').value = sagaId;
            document.getElementById('bookForm').scrollIntoView({ behavior: 'smooth' });
        };
        
        signIn();
    </script>
</body>
</html>
